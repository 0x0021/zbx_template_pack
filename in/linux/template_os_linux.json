{
    "templates": [
        {
            "zbx_ver": "4.2",
            "name": "Template OS Linux Zabbix agent",
            "classes": [
                "OS",
                "PERFORMANCE"
            ],
            "description": "Official Linux template. Requires agent of Zabbix 3.0.14, 3.4.5 and 4.0.0 or newer.",
            "discoveryRules": [
                {
                    "name": "Mounted filesystem discovery",
                    "key": "vfs.fs.discovery",
                    "type": "ZABBIX_PASSIVE",
                    "description": "Discovery of file systems of different types as defined in global regular expression \"File systems for discovery\".",
                    "filter": {
                        "evalType": "AND",
                        "conditions": [
                            {
                                "macro": "{#FSTYPE}",
                                "value": "@File systems for discovery",
                                "operator": "8",
                                "formulaid": "A"
                            }
                        ],
                    },
                    "metrics": [
                        {
                            "_prototype": "vfs.fs.used",
                            "type": "ZABBIX_PASSIVE",
                            "key": "vfs.fs.size[{#FSNAME},used]",
                            "_group": "Filesystems",
                            "_resource": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__"
                        },
                        {
                            "_prototype": "vfs.fs.free",
                            "type": "ZABBIX_PASSIVE",
                            "key": "vfs.fs.size[{#FSNAME},free]",
                            "_group": "Filesystems",
                            "_resource": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__"
                        },
                        {
                            "_prototype": "vfs.fs.total",
                            "type": "ZABBIX_PASSIVE",
                            "key": "vfs.fs.size[{#FSNAME},total]",
                            "_group": "Filesystems",
                            "_resource": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__"
                        },
                        {
                            "_prototype": "vfs.fs.pused",
                            "type": "ZABBIX_PASSIVE",
                            "key": "vfs.fs.size[{#FSNAME},pused]",
                            "_group": "Filesystems",
                            "_resource": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__"
                        },
                        {
                            "_prototype": "vfs.fs.inode.pfree",
                            "type": "ZABBIX_PASSIVE",
                            "key": "vfs.fs.inode[{#FSNAME},pfree]",
                            "_group": "Filesystems",
                            "_resource": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__"
                        }
                    ]
                },
                {
                    "name": "Block devices discovery",
                    "key": "vfs.dev.discovery",
                    "masterItem": "vfs.dev.diskstats",
                    "type": "DEPENDENT_ITEM",
                    "preprocessing": [
                        {
                            "type": "JSONPATH",
                            "params": "$.lld"
                        },
                        {
                            "type": "DISCARD_UNCHANGED_WITH_HEARTBEAT",
                            "params": "1h"
                        }
                    ],
                    "filter": {
                        "evalType": "AND",
                        "conditions": [
                            {
                                "macro": "{#DEVNAME}",
                                "value": "(loop[\\d]*|sda([\\d])+)",
                                "operator": "9", //doesn't match
                                "formulaid": "A"
                            }
                        ],
                    },
                    "metrics": [
                        {
                            "_resource": "{#DEVNAME}",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "_prototype": "vfs.dev.read.rate",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "key": "vfs.dev.read.rate[{#DEVNAME}]",
                            "valueType": "FLOAT",
                            "units": "!r/s",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][3]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                }
                            ],
                            "description": "r/s. The number (after merges) of read requests completed per second for the device."
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "_prototype": "vfs.dev.write.rate",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "key": "vfs.dev.write.rate[{#DEVNAME}]",
                            "valueType": "FLOAT",
                            "units": "!w/s",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][7]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                }
                            ],
                            "description": "w/s. The number (after merges) of write requests completed per second for the device."
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            //"application_prototype": "Disk __ALARM_OBJECT__",
                            "_group": "Internal_items",
                            "_prototype": "vfs.dev.read.time.rate",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "key": "vfs.dev.read.time.rate[{#DEVNAME}]",
                            "valueType": "FLOAT",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][6]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                //convert 'ms' to 'seconds'
                                {
                                    "type": "MULTIPLIER",
                                    "params": "0.001"
                                }
                            ],
                            "description": "Rate of total read time counter. Used in r_await calculation"
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            //"application_prototype": "Disk __ALARM_OBJECT__",
                            "_group": "Internal_items",
                            "_prototype": "vfs.dev.write.time.rate",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "key": "vfs.dev.write.time.rate[{#DEVNAME}]",
                            "valueType": "FLOAT",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][10]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                //convert 'ms' to 'seconds'
                                {
                                    "type": "MULTIPLIER",
                                    "params": "0.001"
                                }
                            ],
                            "description": "Rate of total write time counter. Used in w_await calculation"
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            "_prototype": "vfs.dev.read.await",
                            "key": "vfs.dev.read.await[{#DEVNAME}]",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "type": "CALCULATED",
                            "expression_formula": "(last(__vfs.dev.read.time.rate__)/(last(__vfs.dev.read.rate__)+(last(__vfs.dev.read.rate__)=0)))*1000*(last(__vfs.dev.read.rate__) > 0)",
                            "description": "This formula contains two boolean expressions that evaluates to 1 or 0 in order to set calculated metric to zero and to avoid division by zero exception."
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            "_prototype": "vfs.dev.write.await",
                            "key": "vfs.dev.write.await[{#DEVNAME}]",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "type": "CALCULATED",
                            "expression_formula": "(last(__vfs.dev.write.time.rate__)/(last(__vfs.dev.write.rate__)+(last(__vfs.dev.write.rate__)=0)))*1000*(last(__vfs.dev.write.rate__) > 0)",
                            "description": "This formula contains two boolean expressions that evaluates to 1 or 0 in order to set calculated metric to zero and to avoid division by zero exception."
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            "_prototype": "vfs.dev.queue_size",
                            "key": "vfs.dev.queue_size[{#DEVNAME}]",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][13]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                //to 'seconds'
                                {
                                    "type": "MULTIPLIER",
                                    "params": "0.001"
                                }
                            ]
                        },
                        {
                            "_resource": "{#DEVNAME}",
                            "_prototype": "vfs.dev.util",
                            "key": "vfs.dev.util[{#DEVNAME}]",
                            "application_prototype": "Disk __ALARM_OBJECT__",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "vfs.dev.diskstats",
                            "preprocessing": [
                                {
                                    "type": "JSONPATH",
                                    "params": "$.values['{#DEVNAME}'][12]"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                //to 'seconds'(0.001) and * 100%
                                {
                                    "type": "MULTIPLIER",
                                    "params": "0.1"
                                }
                            ]
                        }
                    ]
                }
            ],
            "metrics": [
                //master item for proc diskstats
                {
                    "_id": "vfs.dev.diskstats",
                    "key": "vfs.file.contents[/proc/diskstats]",
                    "type": "ZABBIX_PASSIVE",
                    "valueType": "TEXT",
                    "name": "Get /proc/diskstats",
                    "_group": "Internal_items",
                    "update": "1m",
                    "history": "1d",
                    "preprocessing": [
                        {
                            "type": "JAVASCRIPT",
                            "params": "var parsed = value.split(\"\\n\").reduce(function(acc, x, i) {\n  acc[\"values\"][x.split(/ +/)[3]] = x.split(/ +/).slice(1)\n  acc[\"lld\"].push({\"{#DEVNAME}\":x.split(/ +/)[3]});\n  return acc;\n}, {\"values\":{}, \"lld\": []});\n\nreturn JSON.stringify(parsed);"
                        }
                    ]
                },
                //CPU
                {
                    "_prototype": "system.cpu.load.avg1",
                    "key": "system.cpu.load[percpu,avg1]",
                    "type": "ZABBIX_PASSIVE",
                    "name": "Load average (1m avg per core)",
                    "description": "The load average is calculated as system CPU load divided by number of CPU cores.",
                    "triggers": [
                        {
                            "_id": "trigger.cpu.load.warn",
                            "name": "Load average is too high",
                            "expression": "{TEMPLATE_NAME:METRIC.avg(5m)}>{$LOAD_AVG_CRIT}",
                            "priority": "WARNING"
                        }
                    ]
                },
                {
                    "_prototype": "system.cpu.load.avg5",
                    "key": "system.cpu.load[percpu,avg5]",
                    "type": "ZABBIX_PASSIVE",
                    "name": "Load average (5m avg per core)",
                    "description": "The load average is calculated as system CPU load divided by number of CPU cores."
                },
                {
                    "_prototype": "system.cpu.load.avg15",
                    "key": "system.cpu.load[percpu,avg15]",
                    "type": "ZABBIX_PASSIVE",
                    "name": "Load average (15m avg per core)",
                    "description": "The load average is calculated as system CPU load divided by number of CPU cores."
                },
                {
                    "_prototype": "system.cpu.util",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "system.cpu.idle",
                    "key": "system.cpu.util",
                    "preprocessing": [
                        {
                            "type": "JAVASCRIPT",
                            "params": "//Calculate utilization\nreturn (100 - value)"
                        },
                    ],
                    "triggers": []
                },
                {
                    "_prototype": "system.cpu.idle",
                    "key": "system.cpu.util[,idle]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.system",
                    "key": "system.cpu.util[,system]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.user",
                    "key": "system.cpu.util[,user]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.nice",
                    "key": "system.cpu.util[,nice]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.iowait",
                    "key": "system.cpu.util[,iowait]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.steal",
                    "key": "system.cpu.util[,steal]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.interrupt",
                    "key": "system.cpu.util[,interrupt]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.softirq",
                    "key": "system.cpu.util[,softirq]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.guest",
                    "key": "system.cpu.util[,guest]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.guest_nice",
                    "key": "system.cpu.util[,guest_nice]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.cpu.switches",
                    "key": "system.cpu.switches",
                    "type": "ZABBIX_PASSIVE",
                    "preprocessing": [
                        {
                            "type": "CHANGE_PER_SECOND"
                        }
                    ]
                },
                {
                    "_prototype": "system.cpu.intr",
                    "key": "system.cpu.intr",
                    "type": "ZABBIX_PASSIVE",
                    "preprocessing": [
                        {
                            "type": "CHANGE_PER_SECOND"
                        }
                    ]
                },
                //MEMORY
                {
                    "_prototype": "vm.memory.total",
                    "key": "vm.memory.size[total]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "vm.memory.available",
                    "key": "vm.memory.size[available]",
                    "type": "ZABBIX_PASSIVE"
                },
                //SWAP,
                {
                    "_prototype": "system.swap.total",
                    "key": "system.swap.size[,total]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.swap.free",
                    "key": "system.swap.size[,free]",
                    "type": "ZABBIX_PASSIVE"
                },
                {
                    "_prototype": "system.swap.pfree",
                    "key": "system.swap.size[,pfree]",
                    "type": "ZABBIX_PASSIVE"
                }
            ],
            "macros": [
                {
                    "macro": "{$LOAD_AVG_CRIT}",
                    "value": "1.5"
                }
            ]
        }
    ]
}