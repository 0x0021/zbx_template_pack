{
    "templates": [
        {
            "name": "Template OS Linux Prom",
            "classes": [
                "OS",
                "PERFORMANCE"
            ],
            "zbxVer": "4.2",
            "description": "Official Linux template using node exporter.",
            "discoveryRules": [
                {
                    "name": "CPU discovery",
                    "masterItem": "node_exporter.get",
                    "type": "DEPENDENT_ITEM",
                    "key": "node_exporter.cpu.discovery",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_TO_JSON",
                            "params": "node_cpu_seconds_total{cpu=~\".+\",mode=\"idle\"}"
                        }
                    ],
                    "lld_macro_paths": [
                        {
                            "lld_macro": "{#CPUNUM}",
                            "path": "$.labels.cpu"
                        },
                        {
                            "lld_macro": "{#HELP}",
                            "path": "$.help"
                        }
                    ],
                    "metrics": [
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.util",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "system.cpu.idle",
                            "key": "node_exporter.system.cpu.util[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "JAVASCRIPT",
                                    "params": "//Calculate utilization\nreturn (100 - value)"
                                },
                            ],
                            "triggers": []
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.idle",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.idle[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"idle\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"

                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.system",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.system[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"system\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"

                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.user",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.user[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"user\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.steal",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.steal[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"steal\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.softirq",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.softirq[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"softirq\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.nice",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.nice[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"nice\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.iowait",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.iowait[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"iowait\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.interrupt",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.interrupt[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_seconds_total{cpu=\"{#CPUNUM}\",mode=\"irq\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.guest",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.guest[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_guest_seconds_total{cpu=\"{#CPUNUM}\",mode=\"user\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                        {
                            "alarmObject": "#{#CPUNUM}",
                            "prototype": "system.cpu.guest_nice",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.system.cpu.guest_nice[{#CPUNUM}]",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_cpu_guest_seconds_total{cpu=\"{#CPUNUM}\",mode=\"nice\"}\r\n"
                                },
                                {
                                    "type": "CHANGE_PER_SECOND"
                                },
                                {
                                    "type": "MULTIPLIER",
                                    "params": "100"
                                }
                            ]
                        },
                    ]
                },
                {
                    "name": "Mounted filesystem discovery",
                    "key": "node_exporter.vfs.fs.discovery",
                    "description": "Discovery of file systems of different types as defined in global regular expression \"File systems for discovery\".",
                    "masterItem": "node_exporter.get",
                    "type": "DEPENDENT_ITEM",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_TO_JSON",
                            "params": "node_filesystem_size_bytes{mountpoint=~\".+\"}"
                        }
                    ],
                    "lld_macro_paths": [
                        {
                            "lld_macro": "{#FSTYPE}",
                            "path": "$.labels.fstype"
                        },
                        {
                            "lld_macro": "{#FSNAME}",
                            "path": "$.labels.mountpoint"
                        },
                        {
                            "lld_macro": "{#FSDEVICE}",
                            "path": "$.labels.device"
                        },
                        {
                            "lld_macro": "{#HELP}",
                            "path": "$.help"
                        }
                    ],
                    "filter": {
                        "evalType":"AND",
                        "conditions":[
                            {
                                "macro":"{#FSTYPE}",
                                "value":"@File systems for discovery",
                                "operator":"8",
                                "formulaid":"A"
                            }
                        ],
                    },
                    "metrics":[
                        {
                            "alarmObject": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__",
                            "prototype": "vfs.fs.free",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.vfs.fs.free[{#FSNAME}]",
                            "valueType": "FLOAT",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_filesystem_avail_bytes{mountpoint=\"{#FSNAME}\"}\r\n"
                                }
                            ]
                        },
                        {
                            "alarmObject": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__",
                            "prototype": "vfs.fs.total",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "key": "node_exporter.vfs.fs.total[{#FSNAME}]",
                            "valueType": "FLOAT",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_PATTERN",
                                    "params": "node_filesystem_size_bytes{mountpoint=\"{#FSNAME}\"}\r\n"
                                }
                            ]
                        },
                        {
                            "alarmObject": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__",
                            "prototype": "vfs.fs.used",
                            "type": "CALCULATED",
                            "key": "node_exporter.vfs.fs.used[{#FSNAME}]",
                            "valueType": "FLOAT"
                        },
                        {
                            "alarmObject": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__",
                            "prototype": "vfs.fs.pused",
                            "type": "CALCULATED",
                            "key": "node_exporter.vfs.fs.pused[{#FSNAME}]",
                            "valueType": "FLOAT"
                        },
                        {
                            "alarmObject": "{#FSNAME}",
                            "application_prototype": "Filesystem __ALARM_OBJECT__",
                            "prototype": "vfs.fs.inode.pfree",
                            "key": "node_exporter.vfs.fs.inode.pfree[{#FSNAME}]",
                            "type": "DEPENDENT_ITEM",
                            "masterItem": "node_exporter.get",
                            "preprocessing": [
                                {
                                    "type": "PROMETHEUS_TO_JSON",
                                    "params": "{__name__=~\"node_filesystem_files.*\",mountpoint=\"{#FSNAME}\"}"
                                },
                                {
                                    "type": "JAVASCRIPT",
                                    "params": "//count vfs.fs.inode.pfree\nvar inode_free;\nvar inode_total;\nJSON.parse(value).forEach(function(metric) {\n  if (metric['name'] == 'node_filesystem_files'){\n      inode_total = metric['value'];\n  } else if (metric['name'] == 'node_filesystem_files_free'){\n      inode_free = metric['value'];\n  }\n});\nreturn (inode_free/inode_total)*100;"
                                }
                            ]
                        }
                    ]
                }
            ],
            "metrics": [
                //get node exporter
                {
                    "id": "node_exporter.get",
                    "key": "node_exporter.get",
                    "delay": "30s",
                    "name": "Get node_exporter metrics",
                    "group": "Internal_items",
                    "history": "1d",
                    "trends": "0",
                    "type": "HTTP_AGENT",
                    "valueType": "TEXT",
                    "url": "http://{HOST.CONN}:{$NODE_EXPORTER_PORT}/metrics"
                },
                //CPU
                {
                    "prototype": "system.cpu.load.avg1",
                    "key": "node_exporter.node_load1",
                    "name": "Load average (1m avg)",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_load1\r\n"
                        }
                    ]
                },
                {
                    "prototype": "system.cpu.load.avg5",
                    "key": "node_exporter.node_load5",
                    "name": "Load average (5m avg)",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_load5\r\n"
                        }
                    ]
                },
                {
                    "prototype": "system.cpu.load.avg15",
                    "key": "node_exporter.node_load15",
                    "name": "Load average (15m avg)",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_load15\r\n"
                        }
                    ]
                },
                {
                    "prototype": "system.cpu.num",
                    "key": "node_exporter.system.cpu.num",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_TO_JSON",
                            "params": "node_cpu_seconds_total{cpu=~\".+\",mode=\"idle\"}"
                        },
                        {
                            "type": "JAVASCRIPT",
                            "params": "//count the number of cores\r\nreturn JSON.parse(value).length\r\n"
                        },
                        {
                            "type": "DISCARD_UNCHANGED_WITH_HEARTBEAT",
                            "params": "1d"
                        }
                    ]
                },
                //"jumps", context switches and interrupts
                {
                    "prototype": "system.cpu.intr",
                    "key": "node_exporter.system.cpu.intr",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_intr_total\r\n"
                        },
                        {
                            "type": "CHANGE_PER_SECOND"
                        }
                    ]
                },
                {
                    "prototype": "system.cpu.switches",
                    "key": "node_exporter.system.cpu.switches",
                    "type": "DEPENDENT_ITEM",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_context_switches_total\r\n"
                        },
                        {
                            "type": "CHANGE_PER_SECOND"
                        }
                    ]
                },
                //MEMORY
                {
                    "prototype": "vm.memory.total",
                    "key": "node_exporter.node_memory_memtotal_bytes",
                    "type": "DEPENDENT_ITEM",
                    "valueType": "FLOAT",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_memory_MemTotal_bytes\r\n"
                        }
                    ]
                },
                {
                    "prototype": "vm.memory.available",
                    "key": "node_exporter.node_memory_memavailable_bytes",
                    "type": "DEPENDENT_ITEM",
                    "valueType": "FLOAT",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_memory_MemAvailable_bytes\r\n"
                        }
                    ]
                },
                //SWAP
                {
                    "prototype": "system.swap.total",
                    "key": "node_exporter.node_memory_swaptotal_bytes",
                    "type": "DEPENDENT_ITEM",
                    "valueType": "FLOAT",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_memory_SwapTotal_bytes\r\n"
                        }
                    ]
                },
                {
                    "prototype": "system.swap.free",
                    "key": "node_exporter.node_memory_swapfree_bytes",
                    "type": "DEPENDENT_ITEM",
                    "valueType": "FLOAT",
                    "masterItem": "node_exporter.get",
                    "preprocessing": [
                        {
                            "type": "PROMETHEUS_PATTERN",
                            "params": "node_memory_SwapFree_bytes\r\n"
                        }
                    ]
                },
                {
                    "prototype": "system.swap.pfree",
                    "type": "CALCULATED",
                    "key": "node_exporter.system.swap.pfree"
                }
            ],
            "macros": [
                {
                    "macro": "{$LOAD_AVG_CRIT}",
                    "value": "1.5"
                },
                {
                    "macro": "{$NODE_EXPORTER_PORT}",
                    "value": "9100"
                }
            ]
        }
    ]
}