templates:
  - name: Template DB Redis
    _zbx_ver: '4.4'
    _classes:
      - DB
    description: |-
      Description

    _documentation:
      _tested_on:
        - name: Redis
          version: 5.0.6

      _overview: |+
        Overview

      _setup: |
        Setup

      _zabbix_forum_url: forum url

    items:
      #################
      ### Raw items ###
      #################
      - _prototype: redis.info
        key: redis.info["{$REDIS.CONN.URI}"]

      - _prototype: redis.config
        key: redis.config["{$REDIS.CONN.URI}"]

      - _prototype: redis.ping
        key: redis.ping["{$REDIS.CONN.URI}"]

      #######################
      ### Dependent items ###
      #######################
      # CPU section
      - _prototype: redis._float
        name: CPU sys
        key: redis.cpu.sys
        units: s
        description: System CPU consumed by the Redis server
        preprocessing:
          - type: JSONPATH
            params: '$.CPU.used_cpu_sys'

      - _prototype: redis._float
        name: CPU sys children
        key: redis.cpu.sys_children
        units: s
        description: System CPU consumed by the background processes
        preprocessing:
          - type: JSONPATH
            params: '$.CPU.used_cpu_sys_children'

      - _prototype: redis._float
        name: CPU user
        key: redis.cpu.user
        units: s
        description: User CPU consumed by the Redis server
        preprocessing:
          - type: JSONPATH
            params: '$.CPU.used_cpu_user'

      - _prototype: redis._float
        name: CPU user children
        key: redis.cpu.user_children
        units: s
        description: User CPU consumed by the background processes
        preprocessing:
          - type: JSONPATH
            params: '$.CPU.used_cpu_user_children'

      # Clients section
      - _prototype: redis._unsigned
        name: Blocked clients
        key: redis.clients.blocked
        description: The number of connections waiting on a blocking call
        preprocessing:
          - type: JSONPATH
            params: '$.Clients.blocked_clients'

      - _prototype: redis._unsigned
        name: 'Max input buffer'
        key: 'redis.clients.max_input_buffer'
        description: The biggest input buffer among current client connections
        preprocessing:
          - type: JAVASCRIPT
            params: |-
              var clients = JSON.parse(value).Clients
              return clients.client_recent_max_input_buffer || clients.client_biggest_input_buf

      - _prototype: redis._unsigned
        name: 'Max output buffer'
        key: 'redis.clients.max_output_buffer'
        description: The biggest output buffer among current client connections
        preprocessing:
          - type: JAVASCRIPT
            params: |-
              var clients = JSON.parse(value).Clients
              return clients.client_recent_max_output_buffer || clients.client_longest_output_list

      - _prototype: redis._unsigned
        name: Connected clients
        key: redis.clients.connected
        description: The number of connected clients
        preprocessing:
          - type: JSONPATH
            params: '$.Clients.connected_clients'

      # Cluster section
      - _prototype: redis._unsigned
        name: Cluster enabled
        key: redis.cluster.enabled
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Cluster.cluster_enabled'

      # Memory section

      - _prototype: redis._unsigned
        name: Memory used
        key: redis.memory.used_memory
        description: 'Amount of memory allocated by Redis'
        preprocessing:
          - type: JSONPATH
            params: '$.Memory.used_memory'

      - _prototype: redis._unsigned
        name: Memory used Lua
        key: redis.memory.used_memory_lua
        description: 'Amount of memory used by the Lua engine'
        preprocessing:
          - type: JSONPATH
            params: '$.Memory.used_memory_lua'

      - _prototype: redis._unsigned
        name: 'Memory used peak'
        key: 'redis.memory.used_memory_peak'
        description: 'Peak amount of memory used by Redis'
        preprocessing:
          - type: JSONPATH
            params: '$.Memory.used_memory_peak'

      - _prototype: redis._unsigned
        name: Memory used RSS
        key: redis.memory.used_memory_rss
        description: 'Amount of memory that Redis allocated as seen by the os'
        preprocessing:
          - type: JSONPATH
            params: '$.Memory.used_memory_rss'

      # Persistence section

      - _prototype: redis._float
        name: AOF current rewrite time in seconds
        key: redis.persistence.aof_current_rewrite_time_sec
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_current_rewrite_time_sec'

      - _prototype: redis._unsigned
        name: AOF enabled
        key: redis.persistence.aof_enabled
        description: 'Flag indicating AOF logging is activated'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_enabled'

      - _prototype: redis._char
        name: AOF last bgrewrite status
        key: redis.persistence.aof_last_bgrewrite_status
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_last_bgrewrite_status'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._float
        name: AOF last rewrite time sec
        key: redis.persistence.aof_last_rewrite_time_sec
        units: s
        description: 'Duration of the last AOF rewrite'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_last_rewrite_time_sec'

      - _prototype: redis._char
        name: AOF last write status
        key: redis.persistence.aof_last_write_status
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_last_write_status'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._unsigned
        name: AOF rewrite in progress
        key: redis.persistence.aof_rewrite_in_progress
        description: 'Flag indicating a AOF rewrite operation is on-going'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_rewrite_in_progress'

      - _prototype: redis._unsigned
        name: AOF rewrite scheduled
        key: redis.persistence.aof_rewrite_scheduled
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.aof_rewrite_scheduled'


      - _prototype: redis._unsigned
        name: Loading
        key: redis.persistence.loading
        description: 'Flag indicating if the load of a dump file is on-going'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.loading'
      
      - _prototype: redis._unsigned
        name: RDB bgsave in progress
        key: redis.persistence.rdb_bgsave_in_progress
        description: '"1" if bgsave is in progress and "0" otherwise'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_bgsave_in_progress'

      - _prototype: redis._unsigned
        name: RDB changes since last save
        key: redis.persistence.rdb_changes_since_last_save
        description: 'Number of changes since the last background save'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_changes_since_last_save'

      - _prototype: redis._float
        name: RDB current bgsave time sec
        key: redis.persistence.rdb_current_bgsave_time_sec
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_current_bgsave_time_sec'

      - _prototype: redis._char
        name: RDB last bgsave status
        key: redis.persistence.rdb_last_bgsave_status
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_last_bgsave_status'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._float
        name: RDB last bgsave time in seconds
        key: redis.persistence.rdb_last_bgsave_time_sec
        units: s
        description: 'Duration of the last bg_save operation'
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_last_bgsave_time_sec'

      - _prototype: redis._unsigned
        name: RDB last save time
        key: redis.persistence.rdb_last_save_time
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Persistence.rdb_last_save_time'

      # Replication section

      - _prototype: redis._unsigned
        name: Connected slaves
        key: redis.replication.connected_slaves
        description: 'Number of connected slaves'
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.connected_slaves'

      - _prototype: redis._unsigned
        name: Replication backlog active
        key: redis.replication.repl_backlog_active
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.repl_backlog_active'

      - _prototype: redis._unsigned
        name: Replication backlog first byte offset
        key: redis.replication.repl_backlog_first_byte_offset
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.repl_backlog_first_byte_offset'

      - _prototype: redis._unsigned
        name: Replication backlog history length
        key: redis.replication.repl_backlog_histlen
        description: 'Amount of data in the backlog sync buffer'
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.repl_backlog_histlen'

      - _prototype: redis._unsigned
        name: Replication backlog size
        key: redis.replication.repl_backlog_size
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.repl_backlog_size'

      - _prototype: redis._char
        name: Replication role
        key: redis.replication.role
        description: 'Value is "master" if the instance is replica of no one, or "slave" if the instance is a replica of some master instance. Note that a replica can be master of another replica (chained replication).'
        preprocessing:
          - type: JSONPATH
            params: '$.Replication.role'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      # Server section

      - _prototype: redis._unsigned
        name: Arch bits
        key: redis.server.arch_bits
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.arch_bits'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._char
        name: Config file
        key: redis.server.config_file
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.config_file'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._unsigned
        name: Process id
        key: redis.server.process_id
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.process_id'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._char
        name: Redis mode
        key: redis.server.redis_mode
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.redis_mode'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._char
        name: Redis version
        key: redis.server.redis_version
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.redis_version'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._unsigned
        name: TCP port
        key: redis.server.tcp_port
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.tcp_port'
          - type: DISCARD_UNCHANGED_HEARTBEAT
            params: 1d

      - _prototype: redis._unsigned
        name: Uptime in days
        key: redis.server.uptime_in_days
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.uptime_in_days'
      
      - _prototype: redis._unsigned
        name: Uptime in seconds
        key: redis.server.uptime_in_seconds
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Server.uptime_in_seconds'

      # Stats section

      - _prototype: redis._unsigned
        name: Evicted keys
        key: redis.stats.evicted_keys
        description: 'Total number of keys evicted due to the maxmemory limit'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.evicted_keys'

      - _prototype: redis._unsigned
        name: Expired keys
        key: redis.stats.expired_keys
        description: 'Total number of keys expired from the db'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.expired_keys'

      - _prototype: redis._float
        name: Expired time cap reached count
        key: redis.stats.expired_time_cap_reached_count
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.expired_time_cap_reached_count'

      - _prototype: redis._float
        name: Instantaneous input bytes per second
        key: redis.stats.instantaneous_input.rate
        units: Bps
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.instantaneous_input_kbps'
          - type: MULTIPLIER
            params: 1024

      - _prototype: redis._unsigned
        name: Instantaneous operations per sec
        key: redis.stats.instantaneous_ops.rate
        description: 'Number of commands processed by the server per second'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.instantaneous_ops_per_sec'

      - _prototype: redis._float
        name: Instantaneous output bytes per second
        key: redis.stats.instantaneous_output.rate
        units: Bps
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.instantaneous_output_kbps'
          - type: MULTIPLIER
            params: 1024

      - _prototype: redis._unsigned
        name: Keyspace hits
        key: redis.stats.keyspace_hits
        description: 'Total number of successful lookups in the main db'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.keyspace_hits'

      - _prototype: redis._unsigned
        name: Keyspace misses
        key: redis.stats.keyspace_misses
        description: 'Total number of missed lookups in the main db'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.keyspace_misses'

      - _prototype: redis._unsigned
        name: Latest fork usec
        key: redis.stats.latest_fork_usec
        units: s
        description: 'Duration of the latest fork'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.latest_fork_usec'
          - type: MULTIPLIER
            params: 0.00001

      - _prototype: redis._unsigned
        name: Migrate cached sockets
        key: redis.stats.migrate_cached_sockets
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.migrate_cached_sockets'

      - _prototype: redis._unsigned
        name: Pubsub channels
        key: redis.stats.pubsub_channels
        description: 'Number of active pubsub channels'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.pubsub_channels'

      - _prototype: redis._unsigned
        name: Pubsub patterns
        key: redis.stats.pubsub_patterns
        description: 'Number of active pubsub patterns'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.pubsub_patterns'

      - _prototype: redis._unsigned
        name: Rejected connections
        key: redis.stats.rejected_connections
        description: 'Number of rejected connections'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.rejected_connections'

      - _prototype: redis._unsigned
        name: Sync full
        key: redis.stats.sync_full
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.sync_full'

      - _prototype: redis._unsigned
        name: Sync partial err
        key: redis.stats.sync_partial_err
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.sync_partial_err'

      - _prototype: redis._unsigned
        name: Sync partial ok
        key: redis.stats.sync_partial_ok
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.sync_partial_ok'

      - _prototype: redis._unsigned
        name: Total commands processed
        key: redis.stats.total_commands_processed
        description: 'Number of commands processed by the server'
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.total_commands_processed'

      - _prototype: redis._unsigned
        name: Total connections received
        key: redis.stats.total_connections_received
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.total_connections_received'

      - _prototype: redis._unsigned
        name: Total net input bytes
        key: redis.stats.total_net_input_bytes
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.total_net_input_bytes'

      - _prototype: redis._unsigned
        name: Total net output bytes
        key: redis.stats.total_net_output_bytes
        description: ''
        preprocessing:
          - type: JSONPATH
            params: '$.Stats.total_net_output_bytes'


    #################
    ### Discovery ###
    #################

    discovery_rules:

      ### Keyspace discovery ###
      ##########################
      - name: 'Keyspace discovery'
        description: |
          Individual keyspace metrics

        key: redis.keyspace.discovery
        type: DEPENDENT
        masterItem: redis.info

        preprocessing:
        # Replace with JSONPATH after fixing the structure in the plugin output
        - type: JAVASCRIPT
          params: 'return JSON.stringify(Object.keys(JSON.parse(value).Keyspace).map(function (v){return {"{#DB}": v}}));'

        filter:
          evalType: 'AND'
          conditions:
            - macro: '{#DB}'
              value: '{$REDIS.LLD.FILTER.DB.MATCHES}'
              operator: 'MATCHES_REGEX'
              formulaid: 'A'

            - macro: '{#DB}'
              value: '{$REDIS.LLD.FILTER.DB.NOT_MATCHES}'
              operator: 'NOT_MATCHES_REGEX'
              formulaid: 'B'

        items:
          - _prototype: redis._unsigned
            name: 'DB {#DB}: Average TTL'
            key: redis.db.avg_ttl["{#DB}"]
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Keyspace["{#DB}"].avg_ttl'

          - _prototype: redis._unsigned
            name: 'DB {#DB}: Expires'
            key: redis.db.expires["{#DB}"]
            description: 'Number of keys with an expiration'
            preprocessing:
              - type: JSONPATH
                params: '$.Keyspace["{#DB}"].expires'

          - _prototype: redis._unsigned
            name: 'DB {#DB}: Keys'
            key: redis.db.keys["{#DB}"]
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Keyspace["{#DB}"].keys'

      - name: 'AOF metrics discovery'
        description: |
          If AOF is activated, additional metrics will be added

        key: redis.persistence.aof.discovery
        type: DEPENDENT
        masterItem: redis.info

        preprocessing:
          - type: JAVASCRIPT
            params: |-
              return JSON.stringify(JSON.parse(value).Persistence.aof_enabled === '1' ? [{'{#SINGLETON}': ''}] : []);
        
        items:
          - _prototype: redis._unsigned
            name: 'AOF current size{#SINGLETON}'
            key: 'redis.persistence.aof_current_size[{#SINGLETON}]'
            units: B
            description: 'AOF current file size'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_current_size'

          - _prototype: redis._unsigned
            name: 'AOF base size{#SINGLETON}'
            key: 'redis.persistence.aof_base_size[{#SINGLETON}]'
            units: B
            description: 'AOF file size on latest startup or rewrite'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_base_size'

          - _prototype: redis._unsigned
            name: 'AOF pending rewrite{#SINGLETON}'
            key: 'redis.persistence.aof_pending_rewrite[{#SINGLETON}]'
            description: 'Flag indicating an AOF rewrite operation will'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_pending_rewrite'

          - _prototype: redis._unsigned
            name: 'AOF buffer length{#SINGLETON}'
            key: 'redis.persistence.aof_buffer_length[{#SINGLETON}]'
            units: B
            description: 'Size of the AOF buffer'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_buffer_length'

          - _prototype: redis._unsigned
            name: 'AOF rewrite buffer length{#SINGLETON}'
            key: 'redis.persistence.aof_rewrite_buffer_length[{#SINGLETON}]'
            units: B
            description: 'Size of the AOF rewrite buffer'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_rewrite_buffer_length'

          - _prototype: redis._unsigned
            name: 'AOF pending background I/O fsync{#SINGLETON}'
            key: 'redis.persistence.aof_pending_bio_fsync[{#SINGLETON}]'
            description: 'Number of fsync pending jobs in background I/O queue'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_pending_bio_fsync'

          - _prototype: redis._unsigned
            name: 'AOF delayed fsync{#SINGLETON}'
            key: 'redis.persistence.aof_delayed_fsync[{#SINGLETON}]'
            description: 'Delayed fsync counter'
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_delayed_fsync'

        ### Slave metrics discovery ###
        ###########################################
      - name: 'Slave metrics discovery'
        description: |
          If the instance is a replica, additional metrics are provided

        key: redis.replication.slave.discovery
        type: DEPENDENT
        masterItem: redis.info

        preprocessing:
          - type: JAVASCRIPT
            params: |-
              return JSON.stringify(JSON.parse(value).Replication.role === 'slave' ? [{'{#SINGLETON}': ''}] : []);

        items:
          - _prototype: redis._char
            name: 'Master host{#SINGLETON}'
            key: redis.replication.master_host[{#SINGLETON}]
            description: 'Host or IP address of the master'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_host'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._unsigned
            name: 'Master port{#SINGLETON}'
            key: redis.replication.master_port[{#SINGLETON}]
            description: 'Master listening TCP port'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_port'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._char
            name: 'Master link status{#SINGLETON}'
            key: redis.replication.master_link_status[{#SINGLETON}]
            description: 'Status of the link (up/down)'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_link_status'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._unsigned
            name: 'Master last I/O seconds ago{#SINGLETON}'
            key: redis.replication.master_last_io_seconds_ago[{#SINGLETON}]
            units: s
            description: 'Number of seconds since the last interaction with master'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_last_io_seconds_ago'

          - _prototype: redis._unsigned
            name: 'Master sync in progress{#SINGLETON}'
            key: redis.replication.master_sync_in_progress[{#SINGLETON}]
            description: 'Indicate the master is syncing to the replica'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_sync_in_progress'

          - _prototype: redis._unsigned
            name: 'Slave replication offset{#SINGLETON}'
            key: redis.replication.slave_repl_offset[{#SINGLETON}]
            description: 'The replication offset of the replica instance'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.slave_repl_offset'

          - _prototype: redis._unsigned
            name: 'Slave priority{#SINGLETON}'
            key: redis.replication.slave_priority[{#SINGLETON}]
            description: 'The priority of the instance as a candidate for failover'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.slave_priority'

          - _prototype: redis._unsigned
            name: 'Slave priority{#SINGLETON}'
            key: redis.replication.slave_read_only[{#SINGLETON}]
            description: 'Flag indicating if the replica is read-only'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.slave_read_only'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d


        ### Process metrics discovery ###
        #################################
      - name: 'Process metrics discovery'
        description: |
          Collect metrics by Zabbix agent if it exists

        key: proc.num["{$REDIS.LLD.PROCESS_NAME}"]
        type: ZABBIX_PASSIVE
        preprocessing:
          - type: JAVASCRIPT
            params: |-
              return JSON.stringify(value > 0 ? [{'{#SINGLETON}': ''}] : []);

        items:
          - _id: redis.process.num
            _prototype: proc.num
            key: proc.num["{$REDIS.PROCESS_NAME}{#SINGLETON}"]
            _group: Redis
            _resource: Redis

          - _id: redis.proc.mem.rss
            _prototype: proc.mem.rss
            key: 'proc.mem["{$REDIS.PROCESS_NAME}{#SINGLETON}",,,,rss]'
            _group: Redis
            _resource: Redis

          - _id: redis.proc.mem.vsize
            _prototype: proc.mem.vsize
            key: 'proc.mem["{$REDIS.PROCESS_NAME}{#SINGLETON}",,,,vsize]'
            _group: Redis
            _resource: Redis
            graphs:
              - name: 'Memory usage{#SINGLETON}'
                graphtype: NORMAL
                graph_items:
                  - name: proc.mem.vsize
                  - name: proc.mem.rss

          - _id: redis.proc.cpu.util
            _prototype: proc.cpu.util
            key: 'proc.cpu.util["{$REDIS.PROCESS_NAME}{#SINGLETON}"]'
            _group: Redis
            _resource: Redis

      ### Metrics for Redis version below 5 ###
      #########################################
      # - name: 'Old metrics discovery'
      #   description: |
      #     Metrics for Redis version below 5

      #   key: redis.metrics.old.discovery
      #   type: DEPENDENT
      #   masterItem: redis.info
      #   preprocessing:
      #     - type: JSONPATH
      #       params: '$.Server.redis_version'
      #     - type: JAVASCRIPT
      #       params: |-
      #         return JSON.stringify(parseInt(value.split('.')[0]) < 5 ? [{'{#SINGLETON}': ''}] : []);

      #   items:
      #     - _prototype: redis._unsigned
      #       name: Max output buffer
      #       key: redis.clients.client_longest_output_list
      #       description: The longest output list among current client connections
      #       preprocessing:
      #         - type: JSONPATH
      #           params: '$.Clients.client_longest_output_list'

      #     - _prototype: redis._unsigned
      #       name: Max input buffer
      #       key: redis.clients.client_biggest_input_buf
      #       description: The biggest input buffer among current client connections
      #       preprocessing:
      #         - type: JSONPATH
      #           params: '$.Clients.client_biggest_input_buf'


      ### Metrics for Redis version 4 and above ###
      ###################################
      - name: 'Version 4+ metrics discovery'
        description: |
          Additional metrics for version 4+

        key: redis.metrics.v4.discovery
        type: DEPENDENT
        masterItem: redis.info
        preprocessing:
          - type: JSONPATH
            params: '$.Server.redis_version'
          - type: JAVASCRIPT
            params: |-
              return JSON.stringify(parseInt(value.split('.')[0]) >= 4 ? [{'{#SINGLETON}': ''}] : []);

        items:
          - _prototype: redis._char
            name: 'Executable path{#SINGLETON}'
            key: 'redis.server.executable[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Server.executable'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._float
            name: 'Memory used peak %{#SINGLETON}'
            key: 'redis.memory.used_memory_peak_perc[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_peak_perc'
              - type: REGEX
                params: "(.+)%\n\\1"

          - _prototype: redis._unsigned
            name: 'Memory used overhead{#SINGLETON}'
            key: 'redis.memory.used_memory_overhead[{#SINGLETON}]'
            description: 'Sum of all overheads allocated by Redis for managing its internal datastructures'
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_overhead'

          - _prototype: redis._unsigned
            name: 'Memory used startup{#SINGLETON}'
            key: 'redis.memory.used_memory_startup[{#SINGLETON}]'
            description: 'Amount of memory consumed by Redis at startup'
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_startup'

          - _prototype: redis._unsigned
            name: 'Memory used dataset{#SINGLETON}'
            key: 'redis.memory.used_memory_dataset[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_dataset'

          - _prototype: redis._float
            name: 'Memory used dataset %{#SINGLETON}'
            key: 'redis.memory.used_memory_dataset_perc[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_dataset_perc'
              - type: REGEX
                params: "(.+)%\n\\1"

          - _prototype: redis._unsigned
            name: 'Total system memory{#SINGLETON}'
            key: 'redis.memory.total_system_memory[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.total_system_memory'

          - _prototype: redis._unsigned
            name: 'Max memory{#SINGLETON}'
            key: 'redis.memory.maxmemory[{#SINGLETON}]'
            description: 'Maximum amount of memory allocated to the Redisdb system'
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.maxmemory'

          - _prototype: redis._char
            name: 'Max memory policy{#SINGLETON}'
            key: 'redis.memory.maxmemory_policy[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.maxmemory_policy'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._unsigned
            name: 'Active defrag running{#SINGLETON}'
            key: 'redis.memory.active_defrag_running[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.active_defrag_running'

          - _prototype: redis._unsigned
            name: 'Lazyfree pending objects{#SINGLETON}'
            key: 'redis.memory.lazyfree_pending_objects[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.lazyfree_pending_objects'

          - _prototype: redis._unsigned
            name: 'RDB last cow size{#SINGLETON}'
            key: 'redis.persistence.rdb_last_cow_size[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.rdb_last_cow_size'

          - _prototype: redis._unsigned
            name: 'AOF last cow size{#SINGLETON}'
            key: 'redis.persistence.aof_last_cow_size[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Persistence.aof_last_cow_size'

          - _prototype: redis._float
            name: 'Expired stale %{#SINGLETON}'
            key: 'redis.stats.expired_stale_perc[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.expired_stale_perc'

          - _prototype: redis._unsigned
            name: 'Expired time cap reached count{#SINGLETON}'
            key: 'redis.stats.expired_time_cap_reached_count[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.expired_time_cap_reached_count'

          - _prototype: redis._unsigned
            name: 'Slave expires tracked keys{#SINGLETON}'
            key: 'redis.stats.slave_expires_tracked_keys[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.slave_expires_tracked_keys'

          - _prototype: redis._unsigned
            name: 'Active defrag hits{#SINGLETON}'
            key: 'redis.stats.active_defrag_hits[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.active_defrag_hits'

          - _prototype: redis._unsigned
            name: 'Active defrag misses{#SINGLETON}'
            key: 'redis.stats.active_defrag_misses[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.active_defrag_misses'

          - _prototype: redis._unsigned
            name: 'Active defrag key hits{#SINGLETON}'
            key: 'redis.stats.active_defrag_key_hits[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.active_defrag_key_hits'

          - _prototype: redis._unsigned
            name: 'Active defrag key misses{#SINGLETON}'
            key: 'redis.stats.active_defrag_key_misses[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Stats.active_defrag_key_misses'

          - _prototype: redis._char
            name: 'Master replication id{#SINGLETON}'
            key: 'redis.replication.master_replid[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_replid'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._char
            name: 'Master replication id 2{#SINGLETON}'
            key: 'redis.replication.master_replid2[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_replid2'
              - type: DISCARD_UNCHANGED_HEARTBEAT
                params: 1d

          - _prototype: redis._unsigned
            name: 'Master replication offset{#SINGLETON}'
            key: 'redis.replication.master_repl_offset[{#SINGLETON}]'
            description: 'Replication offset reported by the master'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.master_repl_offset'

          - _prototype: redis._float
            name: 'Replication second offset{#SINGLETON}'
            key: 'redis.replication.second_repl_offset[{#SINGLETON}]'
            description: 'Offset up to which replication IDs are accepted'
            preprocessing:
              - type: JSONPATH
                params: '$.Replication.second_repl_offset'


      ### Metrics for Redis version 5 ###
      ###################################
      - name: 'Version 5+ metrics discovery'
        description: |
          Additional metrics for version 5+

        key: redis.metrics.v5.discovery
        type: DEPENDENT
        masterItem: redis.info
        preprocessing:
          - type: JSONPATH
            params: '$.Server.redis_version'
          - type: JAVASCRIPT
            params: |-
              return JSON.stringify(value.split('.')[0] === '5' ? [{'{#SINGLETON}': ''}] : []);

        items:

          - _prototype: redis._unsigned
            name: 'Allocator active{#SINGLETON}'
            key: 'redis.memory.allocator_active[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_active'

          - _prototype: redis._unsigned
            name: 'Allocator allocated{#SINGLETON}'
            key: 'redis.memory.allocator_allocated[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_allocated'

          - _prototype: redis._unsigned
            name: 'Allocator resident{#SINGLETON}'
            key: 'redis.memory.allocator_resident[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_resident'

          - _prototype: redis._unsigned
            name: 'Memory used scripts{#SINGLETON}'
            key: 'redis.memory.used_memory_scripts[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.used_memory_scripts'

          - _prototype: redis._unsigned
            name: 'Memory number of cached scripts{#SINGLETON}'
            key: 'redis.memory.number_of_cached_scripts[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.number_of_cached_scripts'

          - _prototype: redis._unsigned
            name: 'Allocator fragmentation bytes{#SINGLETON}'
            key: 'redis.memory.allocator_frag_bytes[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_frag_bytes'

          - _prototype: redis._float
            name: 'Allocator fragmentation ratio{#SINGLETON}'
            key: 'redis.memory.allocator_frag_ratio[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_frag_ratio'

          - _prototype: redis._unsigned
            name: 'Allocator RSS bytes{#SINGLETON}'
            key: 'redis.memory.allocator_rss_bytes[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_rss_bytes'

          - _prototype: redis._float
            name: 'Allocator RSS ratio{#SINGLETON}'
            key: 'redis.memory.allocator_rss_ratio[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.allocator_rss_ratio'

          - _prototype: redis._float
            name: 'Memory RSS overhead bytes{#SINGLETON}'
            key: 'redis.memory.rss_overhead_bytes[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.rss_overhead_bytes'

          - _prototype: redis._float
            name: 'Memory RSS overhead ratio{#SINGLETON}'
            key: 'redis.memory.rss_overhead_ratio[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.rss_overhead_ratio'

          - _prototype: redis._unsigned
            name: 'Memory fragmentation bytes{#SINGLETON}'
            key: 'redis.memory.fragmentation_bytes[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_fragmentation_bytes'

          - _prototype: redis._float
            name: 'Memory fragmentation ratio{#SINGLETON}'
            key: 'redis.memory.fragmentation_ratio[{#SINGLETON}]'
            description: 'Ratio between used_memory_rss and used_memory'
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_fragmentation_ratio'

          - _prototype: redis._unsigned
            name: 'Memory not counted for evict{#SINGLETON}'
            key: 'redis.memory.not_counted_for_evict[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_not_counted_for_evict'

          - _prototype: redis._unsigned
            name: 'Memory replication backlog{#SINGLETON}'
            key: 'redis.memory.replication_backlog[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_replication_backlog'

          - _prototype: redis._unsigned
            name: 'Memory clients normal{#SINGLETON}'
            key: 'redis.memory.mem_clients_normal[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_clients_normal'

          - _prototype: redis._unsigned
            name: 'Memory clients slaves{#SINGLETON}'
            key: 'redis.memory.mem_clients_slaves[{#SINGLETON}]'
            description: ''
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_clients_slaves'

          - _prototype: redis._unsigned
            name: 'Memory AOF buffer{#SINGLETON}'
            key: 'redis.memory.mem_aof_buffer[{#SINGLETON}]' 
            description: 'Size of the AOF buffer'
            preprocessing:
              - type: JSONPATH
                params: '$.Memory.mem_aof_buffer'


    macros:
      - macro: '{$REDIS.CONN.URI}'
        value: 'tcp://localhost:6379'
        description: 'Connection string in the URI format (password is not used). This param overwrites a value configured in the "Server" option of the configuration file (if it''s set), otherwise, the plugin''s default value is used: "tcp://localhost:6379"'

      - macro: '{$REDIS.PROCESS_NAME}'
        value: 'redis-server'
        description: 'Redis server process name'

      - macro: '{$REDIS.LLD.PROCESS_NAME}'
        value: 'redis-server'
        description: 'Redis server process name for LLD'

      - macro: '{$REDIS.LLD.FILTER.DB.MATCHES}'
        value: '.*'
        _description: 'Filter of discoverable databases'

      - macro: '{$REDIS.LLD.FILTER.DB.NOT_MATCHES}'
        value: 'CHANGE_IF_NEEDED'
        _description: 'Filter to exclude discovered databases'

